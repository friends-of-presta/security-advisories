---
layout: post
title: "Chain: SQL Injection (CWE-89) and Eval Injection (CWE-95)"
categories: core
author:
- Friends-Of-Presta.org
meta: "CVE,PrestaShop,core"
severity: "critical (9.8)"
---

In versions from 1.6.0.10 and before 1.7.8.7 PrestaShop is subject to an SQL injection vulnerability which can be chained to call PHP's Eval function on attacker input. 

## Summary

* **CVE ID**: [CVE-2022-31181](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-31181)
* **Published at**: 2022-07-25
* **Advisory source**: PrestaShop
* **Vendor**: PrestaShop
* **Product**: PrestaShop
* **Impacted release**: >=1.6.0.10, 1.7.8.7
* **Product author**: PrestaShop
* **Weakness**: [CWE-89](https://cwe.mitre.org/data/definitions/89.html),  [CWE-95](https://cwe.mitre.org/data/definitions/95.html)
* **Severity**: critical (9.8)

## Description

Eval injection possible if the shop is vulnerable to an SQL injection.
The problem is fixed in version 1.7.8.7. Users are advised to upgrade. Users unable to upgrade may delete the MySQL Smarty cache feature.


## CVSS base metrics

* **Attack vector**: network
* **Attack complexity**: low
* **Privilege required**: none
* **User interaction**: none
* **Scope**: unchanged
* **Confidentiality**: high
* **Integrity**: high
* **Availability**: high

**Vector string**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

## Possible malicious usage

According to [PrestaShop team](https://build.prestashop-project.org/news/2022/major-security-vulnerability-on-prestashop-websites/), this vulnerability has been exploited to add a malicious code.

"After the attackers successfully gained control of a shop, they injected a fake payment form on the front-office checkout page. In this scenario, shop customers might enter their credit card information on the fake form, and unknowingly send it to the attackers."

## Patch

Delete the MySQL Smarty cache feature by removing these lines in the file config/smarty.config.inc.php lines 43-46 (PrestaShop 1.7) or 40-43 (PrestaShop 1.6):

```diff
--- a/config/smarty.config.inc.php
+++ a/config/smarty.config.inc.php
@@ -40,10 +40,6 @@ $smarty->use_sub_dirs = true;
 $smarty->setConfigDir(_PS_SMARTY_DIR_.'configs');
 $smarty->caching = false;
 
-if (Configuration::get('PS_SMARTY_CACHING_TYPE') == 'mysql') {
-    include _PS_CLASS_DIR_.'Smarty/SmartyCacheResourceMysql.php';
-    $smarty->caching_type = 'mysql';
-}
 $smarty->force_compile = (Configuration::get('PS_SMARTY_FORCE_COMPILE') == _PS_SMARTY_FORCE_COMPILE_) ? true : false;
 $smarty->compile_check = (Configuration::get('PS_SMARTY_FORCE_COMPILE') >= _PS_SMARTY_CHECK_COMPILE_) ? true : false;
 $smarty->debug_tpl = _PS_ALL_THEMES_DIR_.'debug.tpl';

```

Or upgrade up to 1.7.8.7.

## Other recommandations

* Upgrade PrestaShop beyond 1.7.8.8 (and 8.0.1) to disable multiquery executions (separated by ";").
* Configure CSP headers (content security policies) by listing  externals domains allowed to load assets (such as js files) or being called in XHR transactions (Ajax).
* Change the default database prefix `ps_` by a new longer arbitrary prefix. Nethertheless, be warned that this is useless against blackhat with DBA senior skill because of a design vulnerability in DBMS
* Activate OWASP 942's rules on your WAF (Web application firewall), be warned that you will probably break your backoffice and you will need to pre-configure some bypasses against these set of rules.

## Links

* [PrestaShop product repository](https://github.com/PrestaShop/PrestaShop/security/advisories/GHSA-hrgx-p36p-89q4)
* [Patch](https://github.com/PrestaShop/PrestaShop/commit/b6d96e7c2a4e35a44e96ffbcdfd34439b56af804)
* [PrestaShop news](https://build.prestashop-project.org/news/2022/major-security-vulnerability-on-prestashop-websites/)

